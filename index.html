<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance Dashboard (V3.0.2-org)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- START: (0.1) STYLES -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* V1.9: Smooth modal animation */
        .modal-backdrop {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        .modal.hidden .modal-backdrop {
            opacity: 0;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
            opacity: 0;
        }
        .modal.show .modal-backdrop {
            opacity: 1;
        }
        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        /* V2.6.0: Calendar Styling */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            min-height: 100px;
            position: relative;
        }
        .calendar-day-header {
            font-size: 0.75rem;
            text-align: center;
            font-weight: 500;
            color: #6b7280; /* text-gray-500 */
        }
        .calendar-day.other-month {
            background-color: #f9fafb; /* bg-gray-50 */
            color: #d1d5db; /* text-gray-300 */
        }
        .calendar-day .day-number {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .calendar-day .day-number.today {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            border-radius: 50%;
            width: 1.75rem;
            height: 1.75rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-item {
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
    <!-- END: (0.1) STYLES -->

</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <!-- 
    ========================================
    (1.0) NAVIGATION
    ========================================
    -->

    <!-- START: (1.1) Mobile Nav -->
    <div class="md:hidden sticky top-0 z-40 bg-white dark:bg-gray-800 shadow-md">
        <div class="flex justify-between items-center px-4 py-3">
            <span class="text-xl font-bold text-blue-600 dark:text-blue-500">MyFinance</span>
            <button id="mobileMenuBtn" class="p-2 rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>
        <nav id="mobileMenu" class="hidden absolute top-full left-0 w-full bg-white dark:bg-gray-800 shadow-lg py-2">
            <a href="#" class="nav-link block px-4 py-3 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-page="dashboard">Dashboard</a>
            <a href="#" class="nav-link block px-4 py-3 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-page="transactions">Transactions</a>
            <a href="#" class="nav-link block px-4 py-3 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-page="accounts">Accounts</a>
            <a href="#" class="nav-link block px-4 py-3 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-page="scheduled">Scheduled</a>
            <!-- V2.8: Removed Budgets Link -->
            <a href="#" class="nav-link block px-4 py-3 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-page="settings">Settings</a>
            <button id="darkModeToggleMobile" class="w-full text-left px-4 py-3 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Toggle Dark Mode</button>
        </nav>
    </div>
    <!-- END: (1.1) Mobile Nav -->

    <div class="flex h-screen">
        <!-- START: (1.2) Sidebar (Desktop) -->
        <nav class="hidden md:flex flex-col w-64 bg-white dark:bg-gray-800 shadow-lg">
            <div class="flex items-center justify-center h-16 shadow-md">
                <span class="text-2xl font-bold text-blue-600 dark:text-blue-500">MyFinance</span>
            </div>
            <div class="flex-1 overflow-y-auto">
                <a href="#" class="nav-link flex items-center px-6 py-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-page="dashboard">
                    <!-- Dashboard Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1V10a1 1 0 011-1h2a1 1 0 011 1v10a1 1 0 001 1m-6 0h6"/></svg>
                    Dashboard
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-page="transactions">
                    <!-- Transactions Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h8m-4 10V5m-4 12h8m-8 0l-2-2m2 2l-2 2m4-4l2-2m-2 2l2 2m-4-4l-2 2m2-2l2-2"/></svg>
                    Transactions
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-page="accounts">
                    <!-- Accounts Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                    Accounts
                </a>
                <a href="#" class="nav-link flex items-center px-6 py-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-page="scheduled">
                    <!-- Scheduled Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    Scheduled
                </a>
                <!-- V2.8: Removed Budgets Link -->
                <a href="#" class="nav-link flex items-center px-6 py-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" data-page="settings">
                    <!-- Settings Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Settings
                </a>
            </div>
            <!-- START: (1.3) Sidebar Footer (Dark Mode) -->
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <button id="darkModeToggle" class="w-full flex items-center justify-center px-4 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <!-- Moon Icon -->
                    <svg id="themeIconLight" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    <!-- Sun Icon -->
                    <svg id="themeIconDark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-12.66l-.707.707M4.04 19.96l-.707.707M21 12h-1M4 12H3m16.66-7.96l-.707-.707M7.04 7.04l-.707-.707" /></svg>
                    Toggle Dark Mode
                </button>
            </div>
            <!-- END: (1.3) Sidebar Footer (Dark Mode) -->
        </nav>
        <!-- END: (1.2) Sidebar (Desktop) -->

        <!-- 
        ========================================
        (2.0) MAIN CONTENT & PAGES
        ========================================
        -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-7xl mx-auto">
                
                <!-- START: (2.1) Loading Screen -->
                <div id="loadingScreen" class="flex justify-center items-center h-screen">
                    <div>
                        <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-lg font-medium">Loading your financial data...</p>
                    </div>
                </div>
                <!-- END: (2.1) Loading Screen -->

                <!-- START: (2.2) Main Content (Hidden until loaded) -->
                <div id="mainContent" class="hidden">
                    
                    <!-- START: (2.3) Page: Dashboard -->
                    <div id="page-dashboard" class="page active">
                        <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
                        
                        <!-- START: (2.3.1) Quick Actions -->
                        <div class="mb-6">
                            <h2 class="text-xl font-semibold mb-3">Quick Actions</h2>
                            <div class="flex flex-wrap gap-2 md:gap-4">
                                <button id="quickAddTxBtn" class="flex-1 md:flex-none flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                    Add Transaction
                                </button>
                                <button id="quickAddAccountBtn" class="flex-1 md:flex-none flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg shadow">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                                    New Account
                                </button>
                                <button id="quickAddScheduledBtn" class="flex-1 md:flex-none flex items-center justify-center bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg shadow">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                    New Scheduled Item
                                </button>
                            </div>
                        </div>
                        <!-- END: (2.3.1) Quick Actions -->

                        <!-- START: (2.3.2) Key Metrics Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Net Worth</h3>
                                <p id="dashboardNetWorth" class="text-3xl font-bold mt-2">$0.00</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Assets</h3>
                                <p id="dashboardTotalAssets" class="text-3xl font-bold mt-2 text-green-600">$0.00</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Liabilities</h3>
                                <p id="dashboardTotalLiabilities" class="text-3xl font-bold mt-2 text-red-600">$0.00</p>
                            </div>
                            <!-- V2.7: Changed to "Remaining" -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Remaining This Month (Projected)</h3>
                                <p id="dashboardRemaining" class="text-3xl font-bold mt-2">$0.00</p>
                            </div>
                        </div>
                        <!-- END: (2.3.2) Key Metrics Grid -->

                        <!-- START: (2.3.3) Net Worth Chart (V3.0) -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                            <h2 class="text-xl font-semibold mb-4">Net Worth (Last 30 Days)</h2>
                            <div class="h-80"> <!-- Set a fixed height for the chart container -->
                                <canvas id="netWorthChart"></canvas>
                            </div>
                        </div>
                        <!-- END: (2.3.3) Net Worth Chart (V3.0) -->

                        <!-- START: (2.3.4) Main Dashboard Row (Spending & Upcoming) -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <!-- START: Spending Chart -->
                            <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-xl font-semibold mb-4">Monthly Spending by Category</h2>
                                <canvas id="spendingChart"></canvas>
                                <!-- V3.0.2: This placeholder is now managed inside renderSpendingChart -->
                            </div>
                            <!-- END: Spending Chart -->
                            
                            <!-- START: Upcoming Payments -->
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                                <h2 class="text-xl font-semibold mb-4">Upcoming (Next 14 Days)</h2>
                                <ul id="dashboardUpcomingList" class="space-y-3 max-h-96 overflow-y-auto">
                                    <!-- Items will be injected by JS -->
                                </ul>
                                <p id="dashboardUpcomingPlaceholder" class="text-gray-500 dark:text-gray-400 hidden">No upcoming items in the next 14 days.</p>
                            </div>
                            <!-- END: Upcoming Payments -->
                        </div>
                        <!-- END: (2.3.4) Main Dashboard Row (Spending & Upcoming) -->
                        
                        <!-- V2.8: Removed Budgets Overview -->
                        
                    </div>
                    <!-- END: (2.3) Page: Dashboard -->
 <!-- START: (2.4) Page: Transactions -->
                    <div id="page-transactions" class="page">
                        <!-- START: (2.4.1) Header -->
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold">Transactions</h1>
                            <button id="addTransactionBtn" class_name="hidden" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow">
                                Add Transaction
                            </button>
                        </div>
                        <!-- END: (2.4.1) Header -->
                        
                        <!-- START: (2.4.2) Transaction Filters -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6">
                            <!-- START: (2.4.2.1) Search Bar -->
                            <div class="mb-4">
                                <label for="filterSearch" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Search by Description</label>
                                <input type="search" id="filterSearch" placeholder="e.g., Costco, Gas, Electric..." class="mt-1 block w-full py-2 px-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <!-- END: (2.4.2.1) Search Bar -->
                            <!-- START: (2.4.2.2) Filter Dropdowns -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label for="filterAccount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Account</label>
                                    <select id="filterAccount" class="mt-1 block w-full py-2 px-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="all">All Accounts</option>
                                        <!-- Account options added by JS -->
                                    </select>
                                </div>
                                <div>
                                    <label for="filterCategory" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                                    <select id="filterCategory" class="mt-1 block w-full py-2 px-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="all">All Categories</option>
                                        <!-- Category options added by JS -->
                                    </select>
                                </div>
                                <div>
                                    <label for="filterType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                                    <select id="filterType" class="mt-1 block w-full py-2 px-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        <option value="all">All Types</option>
                                        <option value="expense">Expense</option>
                                        <option value="income">Income</option>
                                        <option value="transfer">Transfer</option> <!-- V3.0 -->
                                    </select>
                                </div>
                                <div class="self-end">
                                    <button id="resetFiltersBtn" class="w-full bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 font-medium py-2 px-4 rounded-lg shadow">
                                        Reset Filters
                                    </button>
                                </div>
                            </div>
                            <!-- END: (2.4.2.2) Filter Dropdowns -->
                        </div>
                        <!-- END: (2.4.2) Transaction Filters -->

                        <!-- START: (2.4.3) Transaction List Table -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Description</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Category</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Account</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Amount</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionList" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Transaction rows will be injected by JS -->
                                </tbody>
                            </table>
                            <div id="transactionListPlaceholder" class="text-center p-8 hidden">
                                <p class="text-lg text-gray-500 dark:text-gray-400">No transactions found.</p>
                                <p class="text-gray-400 dark:text-gray-500">Try adjusting your filters or add a new transaction.</p>
                            </div>
                        </div>
                        <!-- END: (2.4.3) Transaction List Table -->
                    </div>
                    <!-- END: (2.4) Page: Transactions -->      
 <!-- START: (2.5) Page: Accounts -->
                    <div id="page-accounts" class="page">
                        <!-- START: (2.5.1) Header -->
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold">Accounts</h1>
                            <button id="addAccountBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow">
                                Add Account
                            </button>
                        </div>
                        <!-- END: (2.5.1) Header -->
                        <!-- START: (2.5.2) Account List -->
                        <div id="accountList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Account cards will be injected by JS -->
                        </div>
                        <div id="accountListPlaceholder" class="text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg hidden">
                            <p class="text-lg text-gray-500 dark:text-gray-400">No accounts found.</p>
                            <p class="text-gray-400 dark:text-gray-500">Click "Add Account" to get started!</p>
                        </div>
                        <!-- END: (2.5.2) Account List -->
                    </div>
                    <!-- END: (2.5) Page: Accounts -->

                    <!-- START: (2.6) Page: Scheduled -->
                    <div id="page-scheduled" class="page">
                        <!-- START: (2.6.1) Header -->
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold">Scheduled Items</h1>
                            <button id="addScheduledItemBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow">
                                Add Scheduled Item
                            </button>
                        </div>
                        <!-- END: (2.6.1) Header -->

                        <!-- START: (2.6.2) View Toggle -->
                        <div class="mb-4">
                            <div class="inline-flex rounded-md shadow-sm bg-white dark:bg-gray-800">
                                <button id="scheduledViewListBtn" class="px-4 py-2 rounded-l-lg border border-gray-300 dark:border-gray-600 text-sm font-medium">
                                    List
                                </button>
                                <button id="scheduledViewCalendarBtn" class="px-4 py-2 rounded-r-lg border border-gray-300 dark:border-gray-600 text-sm font-medium">
                                    Calendar
                                </button>
                            </div>
                        </div>
                        <!-- END: (2.6.2) View Toggle -->

                        <!-- START: (2.6.3) List View -->
                        <div id="scheduledListView">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Bills -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                                    <h2 class="text-xl font-semibold p-4 border-b dark:border-gray-700">Scheduled Bills</h2>
                                    <ul id="scheduledBillsList" class="divide-y dark:divide-gray-700">
                                        <!-- Bill items injected by JS -->
                                    </ul>
                                    <p id="scheduledBillsPlaceholder" class="p-6 text-gray-500 dark:text-gray-400 hidden">No scheduled bills.</p>
                                </div>
                                <!-- Income -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg">
                                    <h2 class="text-xl font-semibold p-4 border-b dark:border-gray-700">Scheduled Income</h2>
                                    <ul id="scheduledIncomeList" class="divide-y dark:divide-gray-700">
                                        <!-- Income items injected by JS -->
                                    </ul>
                                    <p id="scheduledIncomePlaceholder" class="p-6 text-gray-500 dark:text-gray-400 hidden">No scheduled income.</p>
                                </div>
                            </div>
                        </div>
                        <!-- END: (2.6.3) List View -->

                        <!-- START: (2.6.4) Calendar View -->
                        <div id="scheduledCalendarView" class="hidden">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <button id="calendarPrevMonthBtn" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                                    </button>
                                    <h2 id="calendarMonthYear" class="text-xl font-semibold"></h2>
                                    <button id="calendarNextMonthBtn" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                    </button>
                                </div>
                                <div class="calendar-grid">
                                    <!-- Day headers -->
                                    <div class="calendar-day-header">Sun</div>
                                    <div class="calendar-day-header">Mon</div>
                                    <div class="calendar-day-header">Tue</div>
                                    <div class="calendar-day-header">Wed</div>
                                    <div class="calendar-day-header">Thu</div>
                                    <div class="calendar-day-header">Fri</div>
                                    <div class="calendar-day-header">Sat</div>
                                </div>
                                <div id="calendarDaysGrid" class="calendar-grid">
                                    <!-- Calendar days will be injected by JS -->
                                </div>
                            </div>
                        </div>
                        <!-- END: (2.6.4) Calendar View -->
                    </div>
                    <!-- END: (2.6) Page: Scheduled -->

                    <!-- V2.8: Removed Budgets Page -->

                    <!-- START: (2.7) Page: Settings -->
                    <div id="page-settings" class="page">
                        <h1 class="text-3xl font-bold mb-6">Settings</h1>
                        
                        <!-- START: (2.7.1) User Info & Data -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 max-w-md">
                            <h2 class="text-xl font-semibold mb-4">User Info</h2>
                            <p class="mb-2"><strong>User ID:</strong> <span id="settingsUserId" class="font-mono text-sm"></span></p>
                            <p class="mb-4"><strong>Authentication:</strong> <span id="settingsAuthStatus" class="font-medium"></span></p>
                            
                            <h2 class="text-xl font-semibold mb-4 mt-6">Data Management</h2>
                            <button id="exportDataBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg shadow mb-3">
                                Export My Data (JSON)
                            </button>
                            <button id="dangerZoneToggle" class="w-full text-left text-red-600 dark:text-red-500 font-medium">
                                Show Danger Zone
                            </button>
                            <div id="dangerZone" class="hidden mt-4 pt-4 border-t border-red-300 dark:border-red-700">
                                <p class="text-sm text-red-700 dark:text-red-300 mb-3">Warning: These actions are permanent and cannot be undone.</p>
                                <button id="deleteAllDataBtn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg shadow">
                                    Delete All My Data
                                </button>
                            </div>
                        </div>
                        <!-- END: (2.7.1) User Info & Data -->

                        <!-- START: (2.7.2) Manage Categories -->
                        <div class="mt-8">
                            <h2 class="text-2xl font-bold mb-4">Manage Categories</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Expense Categories -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                                    <h3 class="text-xl font-semibold mb-4">Expense Categories</h3>
                                    <form id="addExpenseCategoryForm" class="flex gap-2 mb-4">
                                        <input type="text" id="newExpenseCategory" placeholder="New expense category" class="flex-1 p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow">Add</button>
                                    </form>
                                    <ul id="expenseCategoryList" class="space-y-2 max-h-60 overflow-y-auto">
                                        <!-- JS will populate this -->
                                        <li class="text-gray-500 dark:text-gray-400">Loading categories...</li>
                                    </ul>
                                </div>
                                <!-- Income Categories -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                                    <h3 class="text-xl font-semibold mb-4">Income Categories</h3>
                                    <form id="addIncomeCategoryForm" class="flex gap-2 mb-4">
                                        <input type="text" id="newIncomeCategory" placeholder="New income category" class="flex-1 p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg shadow">Add</button>
                                    </form>
                                    <ul id="incomeCategoryList" class="space-y-2 max-h-60 overflow-y-auto">
                                        <!-- JS will populate this -->
                                        <li class="text-gray-500 dark:text-gray-400">Loading categories...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- END: (2.7.2) Manage Categories -->
                    </div>
                    <!-- END: (2.7) Page: Settings -->

                </div> <!-- END: (2.2) Main Content -->
            </div>
        </main>
    </div>

    <!-- 
    ========================================
    (3.0) MODALS
    ========================================
    -->

    <!-- START: (3.1) Add/Edit Transaction Modal -->
    <div id="transactionModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <!-- Backdrop -->
        <div class="modal-backdrop fixed inset-0 bg-black/50"></div>
        <!-- Content -->
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-lg shadow-xl relative">
            <h2 id="transactionModalTitle" class="text-2xl font-bold mb-6">Add Transaction</h2>
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                
                <!-- START: (3.1.1) Transaction Type Toggle -->
                <div class="mb-4">
                    <div class="flex rounded-md shadow-sm">
                        <button type="button" id="txTypeExpense" class="flex-1 py-2 px-4 rounded-l-md text-sm font-medium">Expense</button>
                        <button type="button" id="txTypeTransfer" class="flex-1 py-2 px-4 text-sm font-medium border-t border-b">Transfer</button>
                        <button type="button" id="txTypeIncome" class="flex-1 py-2 px-4 rounded-r-md text-sm font-medium">Income</button>
                    </div>
                </div>
                <!-- END: (3.1.1) Transaction Type Toggle -->

                <div class="mb-4">
                    <label for="transactionDescription" class="block text-sm font-medium mb-1">Description</label>
                    <input type="text" id="transactionDescription" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="transactionAmount" class="block text-sm font-medium mb-1">Amount</label>
                    <input type="number" id="transactionAmount" step="0.01" min="0" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="transactionDate" class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="transactionDate" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                
                <!-- START: (3.1.2) "From" Account -->
                <div id="txFromAccountWrapper" class="mb-4">
                    <label for="transactionAccount" class="block text-sm font-medium mb-1">Account</label>
                    <select id="transactionAccount" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                        <option value="">Select an account</option>
                        <!-- Options loaded by JS -->
                    </select>
                </div>
                <!-- END: (3.1.2) "From" Account -->
                
                <!-- START: (3.1.3) "To" Account (for Transfers) -->
                <div id="txToAccountWrapper" class="mb-4 hidden">
                    <label for="transactionAccountTo" class="block text-sm font-medium mb-1">To Account</label>
                    <select id="transactionAccountTo" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                        <option value="">Select an account</option>
                        <!-- Options loaded by JS -->
                    </select>
                </div>
                <!-- END: (3.1.3) "To" Account (for Transfers) -->
                
                <!-- START: (3.1.4) Category (for Expense/Income) -->
                <div id="txCategoryWrapper" class="mb-4">
                    <label for="transactionCategory" class="block text-sm font-medium mb-1">Category</label>
                    <select id="transactionCategory" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                        <!-- Options loaded by JS -->
                    </select>
                </div>
                <!-- END: (3.1.4) Category (for Expense/Income) -->
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelTransactionBtn" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 font-medium py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="saveTransactionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Save</button>
                    <button type="button" id="deleteTransactionBtn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg hidden">Delete</button>
                </div>
            </form>
        </div>
    </div>
    <!-- END: (3.1) Add/Edit Transaction Modal -->
    
    <!-- START: (3.2) Add/Edit Account Modal -->
    <div id="accountModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <!-- Backdrop -->
        <div class="modal-backdrop fixed inset-0 bg-black/50"></div>
        <!-- Content -->
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-lg shadow-xl relative">
            <h2 id="accountModalTitle" class="text-2xl font-bold mb-6">Add Account</h2>
            <form id="accountForm">
                <input type="hidden" id="accountId">
                <div class="mb-4">
                    <label for="accountName" class="block text-sm font-medium mb-1">Account Name</label>
                    <input type="text" id="accountName" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="accountType" class="block text-sm font-medium mb-1">Account Type</label>
                    <select id="accountType" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                        <option value="checking">Checking</option>
                        <option value="savings">Savings</option>
                        <option value="credit">Credit Card</option>
                        <option value="investment">Investment</option>
                        <!-- V2.7: Added Retirement -->
                        <option value="retirement">Retirement</option>
                        <option value="loan">Loan</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="accountBalance" class="block text-sm font-medium mb-1">Current Balance</label>
                    <input type="number" id="accountBalance" step="0.01" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelAccountBtn" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 font-medium py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="saveAccountBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>
    <!-- END: (3.2) Add/Edit Account Modal -->

    <!-- START: (3.3) Add/Edit Scheduled Item Modal -->
    <div id="scheduledItemModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <!-- Backdrop -->
        <div class="modal-backdrop fixed inset-0 bg-black/50"></div>
        <!-- Content -->
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-lg shadow-xl relative">
            <h2 id="scheduledItemModalTitle" class="text-2xl font-bold mb-6">Add Scheduled Item</h2>
            <form id="scheduledItemForm">
                <input type="hidden" id="scheduledItemId">
                
                <div class="mb-4">
                    <div class="flex rounded-md shadow-sm">
                        <button type="button" id="scheduledTypeBill" class="flex-1 py-2 px-4 rounded-l-md text-sm font-medium">Bill</button>
                        <button type="button" id="scheduledTypeIncome" class="flex-1 py-2 px-4 rounded-r-md text-sm font-medium">Income</button>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="scheduledDescription" class="block text-sm font-medium mb-1">Description</label>
                    <input type="text" id="scheduledDescription" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="scheduledAmount" class="block text-sm font-medium mb-1">Amount</label>
                    <input type="number" id="scheduledAmount" step="0.01" min="0" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="scheduledStartDate" class="block text-sm font-medium mb-1">Start Date</label>
                    <input type="date" id="scheduledStartDate" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="scheduledRecurring" class="block text-sm font-medium mb-1">Frequency</label>
                    <select id="scheduledRecurring" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                        <option value="once">One Time</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Every 2 Weeks</option>
                        <option value="monthly">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="scheduledCategory" class="block text-sm font-medium mb-1">Category</label>
                    <select id="scheduledCategory" class="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                        <!-- Options loaded by JS -->
                    </select>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelScheduledItemBtn" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 font-medium py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="saveScheduledItemBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>
    <!-- END: (3.3) Add/Edit Scheduled Item Modal -->

    <!-- V2.8: Removed Budget Modal -->
    
    <!-- START: (3.4) Generic Delete Confirmation Modal -->
    <div id="deleteModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <!-- Backdrop -->
        <div class="modal-backdrop fixed inset-0 bg-black/50"></div>
        <!-- Content -->
        <div class="modal-content bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-lg shadow-xl relative">
            <h2 class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="deleteModalMessage" class="text-gray-700 dark:text-gray-300 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancelDeleteBtn" class="bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 font-medium py-2 px-4 rounded-lg">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Delete</button>
            </div>
        </div>
    </div>
    <!-- END: (3.4) Generic Delete Confirmation Modal -->
    
    <!-- 
    ========================================
    (4.0) JAVASCRIPT
    ========================================
    -->
    <script type="module">
        // =================================================================
        // (4.1) FIREBASE IMPORTS
        // =================================================================
        // START: (4.1.1) Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            addDoc, 
            getDocs,
            writeBatch,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // END: (4.1.1) Firebase Imports
        // =================================================================
        // (END 4.1)
        // =================================================================

        /* START: (TEMP FIX) Placeholder
         * This is a temporary function to prevent errors while pasting parts.
         * The real function is in Part 4.
         */
        function initializeDataListeners() {
            console.log("DEBUG: Placeholder initializeDataListeners called. App not fully loaded.");
        }
        /* END: (TEMP FIX) */

        // =================================================================
        // (4.2) FIREBASE & APP INITIALIZATION
        // =================================================================
        
        // START: (4.2.1) Firebase Config
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'myfinance-dashboard-app';
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Firebase config is not available or invalid. Using default.");
            // Default config for local testing (replace with your own if needed)
            firebaseConfig = {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_SENDER_ID",
                appId: "YOUR_APP_ID"
            };
        }
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        
        setLogLevel('Debug');
        // END: (4.2.1) Firebase Config
        
        // =================================================================
        // (END 4.2)
        // =================================================================


        // =================================================================
        // (4.3) GLOBAL STATE
        // =================================================================
        let userAccounts = [];
        let userTransactions = [];
        let userScheduledItems = [];
        let userExpenseCategories = [];
        let userIncomeCategories = [];
        let spendingChart = null;
        let netWorthChart = null; // V3.0
        let currentCalendarDate = new Date();
        // =================================================================
        // (END 4.3)
        // =================================================================


        // =================================================================
        // (4.4) DOM ELEMENT SELECTORS
        // =================================================================
        
        // START: (4.4.1) Navigation
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        // END: (4.4.1) Navigation
        
        // START: (4.4.2) Dark Mode
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeToggleMobile = document.getElementById('darkModeToggleMobile');
        const themeIconLight = document.getElementById('themeIconLight');
        const themeIconDark = document.getElementById('themeIconDark');
        // END: (4.4.2) Dark Mode
        
        // START: (4.4.3) Transaction Modal
        const transactionModal = document.getElementById('transactionModal');
        const transactionForm = document.getElementById('transactionForm');
        const transactionModalTitle = document.getElementById('transactionModalTitle');
        const addTransactionBtn = document.getElementById('addTransactionBtn');
        const cancelTransactionBtn = document.getElementById('cancelTransactionBtn');
        const saveTransactionBtn = document.getElementById('saveTransactionBtn');
        const deleteTransactionBtn = document.getElementById('deleteTransactionBtn');
        const txTypeExpense = document.getElementById('txTypeExpense');
        const txTypeIncome = document.getElementById('txTypeIncome');
        const txTypeTransfer = document.getElementById('txTypeTransfer');
        const txFromAccountWrapper = document.getElementById('txFromAccountWrapper');
        const txToAccountWrapper = document.getElementById('txToAccountWrapper');
        const txCategoryWrapper = document.getElementById('txCategoryWrapper');
        const transactionAccountTo = document.getElementById('transactionAccountTo');
        const transactionCategory = document.getElementById('transactionCategory');
        // END: (4.4.3) Transaction Modal
        
        // START: (4.4.4) Account Modal
        const accountModal = document.getElementById('accountModal');
        const accountForm = document.getElementById('accountForm');
        const accountModalTitle = document.getElementById('accountModalTitle');
        const addAccountBtn = document.getElementById('addAccountBtn');
        const cancelAccountBtn = document.getElementById('cancelAccountBtn');
        const saveAccountBtn = document.getElementById('saveAccountBtn');
        // END: (4.4.4) Account Modal
        
        // START: (4.4.5) Scheduled Item Modal
        const scheduledItemModal = document.getElementById('scheduledItemModal');
        const scheduledItemForm = document.getElementById('scheduledItemForm');
        const scheduledItemModalTitle = document.getElementById('scheduledItemModalTitle');
        const addScheduledItemBtn = document.getElementById('addScheduledItemBtn');
        const cancelScheduledItemBtn = document.getElementById('cancelScheduledItemBtn');
        const saveScheduledItemBtn = document.getElementById('saveScheduledItemBtn');
        const scheduledTypeBill = document.getElementById('scheduledTypeBill');
        const scheduledTypeIncome = document.getElementById('scheduledTypeIncome');
        const scheduledCategorySelect = document.getElementById('scheduledCategory');
        // END: (4.4.5) Scheduled Item Modal
        
        // START: (4.4.6) Delete Modal
        const deleteModal = document.getElementById('deleteModal');
        const deleteModalMessage = document.getElementById('deleteModalMessage');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        // END: (4.4.6) Delete Modal
        
        // START: (4.4.7) Dashboard Page
        const dashboardNetWorth = document.getElementById('dashboardNetWorth');
        const dashboardTotalAssets = document.getElementById('dashboardTotalAssets');
        const dashboardTotalLiabilities = document.getElementById('dashboardTotalLiabilities');
        const dashboardRemaining = document.getElementById('dashboardRemaining');
        const dashboardUpcomingList = document.getElementById('dashboardUpcomingList');
        const dashboardUpcomingPlaceholder = document.getElementById('dashboardUpcomingPlaceholder');
        const quickAddTxBtn = document.getElementById('quickAddTxBtn');
        const quickAddAccountBtn = document.getElementById('quickAddAccountBtn');
        const quickAddScheduledBtn = document.getElementById('quickAddScheduledBtn');
        // END: (4.4.7) Dashboard Page
        
        // START: (4.4.8) Transactions Page
        const transactionList = document.getElementById('transactionList');
        const transactionListPlaceholder = document.getElementById('transactionListPlaceholder');
        const filterSearch = document.getElementById('filterSearch');
        const filterAccount = document.getElementById('filterAccount');
        const filterCategory = document.getElementById('filterCategory');
        const filterType = document.getElementById('filterType');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        // END: (4.4.8) Transactions Page
        
        // START: (4.4.9) Accounts Page
        const accountList = document.getElementById('accountList');
        const accountListPlaceholder = document.getElementById('accountListPlaceholder');
        // END: (4.4.9) Accounts Page
        
        // START: (4.4.10) Scheduled Page
        const scheduledViewListBtn = document.getElementById('scheduledViewListBtn');
        const scheduledViewCalendarBtn = document.getElementById('scheduledViewCalendarBtn');
        const scheduledListView = document.getElementById('scheduledListView');
        const scheduledCalendarView = document.getElementById('scheduledCalendarView');
        const scheduledBillsList = document.getElementById('scheduledBillsList');
        const scheduledIncomeList = document.getElementById('scheduledIncomeList');
        const scheduledBillsPlaceholder = document.getElementById('scheduledBillsPlaceholder');
        const scheduledIncomePlaceholder = document.getElementById('scheduledIncomePlaceholder');
        const calendarPrevMonthBtn = document.getElementById('calendarPrevMonthBtn');
        const calendarNextMonthBtn = document.getElementById('calendarNextMonthBtn');
        const calendarMonthYear = document.getElementById('calendarMonthYear');
        const calendarDaysGrid = document.getElementById('calendarDaysGrid');
        // END: (4.4.10) Scheduled Page
        
        // START: (4.4.11) Settings Page
        const exportDataBtn = document.getElementById('exportDataBtn');
        const dangerZoneToggle = document.getElementById('dangerZoneToggle');
        const dangerZone = document.getElementById('dangerZone');
        const deleteAllDataBtn = document.getElementById('deleteAllDataBtn');
        const addExpenseCategoryForm = document.getElementById('addExpenseCategoryForm');
        const newExpenseCategory = document.getElementById('newExpenseCategory');
        const expenseCategoryList = document.getElementById('expenseCategoryList');
        const addIncomeCategoryForm = document.getElementById('addIncomeCategoryForm');
        const newIncomeCategory = document.getElementById('newIncomeCategory');
        const incomeCategoryList = document.getElementById('incomeCategoryList');
        // END: (4.4.11) Settings Page
        
        // =================================================================
        // (END 4.4)
        // =================================================================


        // =================================================================
        // (5.0) AUTHENTICATION
        // =================================================================
        
        // START: (5.1) Auth State Changed (Main App Controller)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("DEBUG: User is signed in:", user.uid);
                userId = user.uid;
                
                // V3.0.1: FIX - Get DOM elements *inside* callback to ensure they exist
                const settingsUserId = document.getElementById('settingsUserId');
                const settingsAuthStatus = document.getElementById('settingsAuthStatus');
                const loadingScreen = document.getElementById('loadingScreen');
                const mainContent = document.getElementById('mainContent');

                // V2.0: Update Settings Page
                if (settingsUserId) {
                    settingsUserId.textContent = userId;
                } else {
                    console.warn("DEBUG: settingsUserId element not found.");
                }
                if (settingsAuthStatus) {
                    settingsAuthStatus.textContent = user.isAnonymous ? "Anonymous" : "Authenticated";
                } else {
                    console.warn("DEBUG: settingsAuthStatus element not found.");
                }
                
                // V1.9: Initialize data listeners
                initializeDataListeners();
                
                // V1.9: Show the main content
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                } else {
                    console.warn("DEBUG: loadingScreen element not found.");
                }
                if (mainContent) {
                    mainContent.classList.remove('hidden');
                } else {
                    console.warn("DEBUG: mainContent element not found.");
                }
                
            } else {
                console.log("DEBUG: User is signed out. Attempting anonymous sign in.");
                // V1.9: User is signed out, try to sign in
                signInUser();
            }
        });
        // END: (5.1) Auth State Changed (Main App Controller)

        // START: (5.2) Sign In User
        async function signInUser() {
            // V3.0.1: Get loading screen here too for error case
            const loadingScreen = document.getElementById('loadingScreen');
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("DEBUG: Attempting sign in with custom token.");
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    console.log("DEBUG: Attempting anonymous sign in.");
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                if (loadingScreen) {
                    loadingScreen.innerHTML = `<p class="text-red-500">Error: Could not authenticate. ${error.message}</p>`;
                }
            }
        }
        // END: (5.2) Sign In User
        
        // =================================================================
        // (END 5.0)
        // =================================================================    
        // =================================================================
        // (6.0) DATA LISTENERS
        // =================================================================

        // START: (6.1) Initialize Data Listeners
        function initializeDataListeners() {
            if (!userId) return;
            console.log("DEBUG: Initializing data listeners for user:", userId);

            // START: (6.1.1) Accounts Listener
            // V3.0.3: FIX - Added correct collection path
            const accountsQuery = collection(db, `artifacts/${appId}/users/${userId}/accounts`);
            onSnapshot(accountsQuery, (snapshot) => {
                console.log(`DEBUG: Received accounts snapshot with ${snapshot.size} docs.`);
                userAccounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // V2.2: Sort accounts by name for dropdowns
                userAccounts.sort((a, b) => a.name.localeCompare(b.name));
                
                // V1.9: Re-render relevant parts
                renderAccountsPage();
                populateAccountOptions(); // V2.2
                renderDashboard(); // V2.1: Net Worth depends on accounts
                renderTransactionsPage(); // V2.2: Balances depend on Txs, but filters need accounts
            }, (error) => {
                console.error("Error fetching accounts:", error);
            });
            // END: (6.1.1) Accounts Listener

            // START: (6.1.2) Transactions Listener
            // V3.0.3: FIX - Added correct collection path
            const txQuery = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            onSnapshot(txQuery, (snapshot) => {
                console.log(`DEBUG: Received transactions snapshot with ${snapshot.size} docs.`);
                userTransactions = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    // V2.2: Ensure date is a JS Date object
                    date: doc.data().date.toDate ? doc.data().date.toDate() : new Date(doc.data().date)
                }));
                // V2.2: Sort transactions by date (newest first)
                userTransactions.sort((a, b) => b.date - a.date);
                
                // V1.9: Re-render relevant parts
                renderTransactionsPage();
                renderDashboard(); // V2.1: Spending/charts depend on Txs
                // V2.8: renderBudgetsPage();
            }, (error) => {
                console.error("Error fetching transactions:", error);
            });
            // END: (6.1.2) Transactions Listener
            
            // START: (6.1.3) Scheduled Items Listener
            // V3.0.3: FIX - Added correct collection path
            const scheduledQuery = collection(db, `artifacts/${appId}/users/${userId}/scheduledItems`);
            onSnapshot(scheduledQuery, (snapshot) => {
                console.log(`DEBUG: Received scheduled items snapshot with ${snapshot.size} docs.`);
                userScheduledItems = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(),
                    // V2.4: Ensure date is a JS Date object
                    startDate: doc.data().startDate.toDate ? doc.data().startDate.toDate() : new Date(doc.data().startDate)
                }));
                // V2.4: Sort by start date
                userScheduledItems.sort((a, b) => a.startDate - b.startDate);
                
                renderScheduledPage();
                renderDashboard(); // V2.1: Upcoming items
            }, (error) => {
                console.error("Error fetching scheduled items:", error);
            });
            // END: (6.1.3) Scheduled Items Listener

            // START: (6.1.4) Categories Listener
            // V3.0.3: FIX - Added correct collection path
            const categoriesQuery = collection(db, `artifacts/${appId}/users/${userId}/categories`);
            onSnapshot(categoriesQuery, async (snapshot) => {
                console.log(`DEBUG: Received categories snapshot with ${snapshot.size} docs.`);
                
                if (snapshot.empty) {
                    // First-time user, create default categories
                    console.log("DEBUG: No categories found, creating defaults.");
                    await createDefaultCategories();
                    // Listener will re-run after this, so we can just return
                    return;
                }
                
                // Clear existing
                userExpenseCategories = [];
                userIncomeCategories = [];
                
                snapshot.docs.forEach(doc => {
                    const category = { id: doc.id, ...doc.data() };
                    if (category.type === 'expense') {
                        userExpenseCategories.push(category);
                    } else if (category.type === 'income') {
                        userIncomeCategories.push(category);
                    }
                });
                
                // Re-render category-dependent UI
                renderCategorySettings(); // V2.9: Settings page list
                populateCategoryOptions(); // V2.9: All dropdowns
                
            }, (error) => {
                console.error("Error fetching categories:", error);
            });
            // END: (6.1.4) Categories Listener

            // V2.8: Removed Budgets Listener
        }
        // END: (6.1) Initialize Data Listeners
        
        // =================================================================
        // (END 6.0)
        // =================================================================


        // =================================================================
        // (7.0) NAVIGATION & UI HELPERS
        // =================================================================
        
        // START: (7.1) Show Page
        function showPage(pageId) {
            console.log("DEBUG: Navigating to page:", pageId);
            // Hide all pages
            pages.forEach(page => page.classList.remove('active'));
            
            // Show the target page
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
            } else {
                console.warn(`WARN: Page not found: ${pageId}. Defaulting to dashboard.`);
                document.getElementById('page-dashboard').classList.add('active');
            }
            
            // Update active nav link
            navLinks.forEach(link => {
                link.classList.toggle('bg-gray-100', link.dataset.page === pageId);
                link.classList.toggle('dark:bg-gray-700', link.dataset.page === pageId);
            });

            // Close mobile menu if open
            if (mobileMenu) {
                mobileMenu.classList.add('hidden');
            }
        }
        // END: (7.1) Show Page

        // START: (7.2) Nav Link Listeners
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.dataset.page;
                showPage(pageId);
            });
        });
        // END: (7.2) Nav Link Listeners

        // START: (7.3) Mobile Menu Toggle
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                if (mobileMenu) {
                    mobileMenu.classList.toggle('hidden');
                }
            });
        }
        // END: (7.3) Mobile Menu Toggle

        // START: (7.4) Dark Mode
        function setDarkMode(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                if(themeIconLight) themeIconLight.classList.remove('hidden');
                if(themeIconDark) themeIconDark.classList.add('hidden');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                if(themeIconLight) themeIconLight.classList.add('hidden');
                if(themeIconDark) themeIconDark.classList.remove('hidden');
                localStorage.setItem('theme', 'light');
            }
        }
        
        const themeToggleFn = () => {
            setDarkMode(!document.documentElement.classList.contains('dark'));
        };
        
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', themeToggleFn);
        }
        if (darkModeToggleMobile) {
            darkModeToggleMobile.addEventListener('click', themeToggleFn);
        }
        // END: (7.4) Dark Mode

        // START: (7.5) Generic Modal Controls
        function openModal(modal) {
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
            }
        }

        function closeModal(modal) {
            if (modal) {
                modal.classList.remove('show');
                // Give animation time to finish
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200);
            }
        }
        
        // Close modals on backdrop click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-backdrop')) {
                    closeModal(modal);
                }
            });
        });
        // END: (7.5) Generic Modal Controls
        
        // =================================================================
        // (END 7.0)
        // =================================================================
        
        
        // =================================================================
        // (8.0) FORMATTING & DATE HELPERS
        // =================================================================

        // START: (8.1) Format Currency
        function formatCurrency(value) {
            // V2.1: Handle non-number inputs gracefully
            const num = parseFloat(value);
            if (isNaN(num)) {
                return "$0.00";
            }
            return num.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }
        // END: (8.1) Format Currency
        
        // START: (8.2) Format Date
        function formatDate(date) {
            // V2.2: Ensure date is a JS Date object
            const d = (date instanceof Date) ? date : new Date(date);
            if (isNaN(d.getTime())) {
                return "Invalid Date";
            }
            return d.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        // END: (8.2) Format Date

        // START: (8.3) Format Date Short (for Charts)
        function formatDateShort(date) {
            const d = (date instanceof Date) ? date : new Date(date);
            if (isNaN(d.getTime())) {
                return "Invalid";
            }
            return d.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }
        // END: (8.3) Format Date Short (for Charts)

        // START: (8.4) Format Date Month/Day
        function formatDateMonthDay(date) {
            // V2.1: For upcoming payments
            const d = (date instanceof Date) ? date : new Date(date);
            if (isNaN(d.getTime())) {
                return "Invalid Date";
            }
            return d.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }
        // END: (8.4) Format Date Month/Day
        
        // START: (8.5) Get ISO Date
        function getISODate(date = new Date()) {
            // V1.8: For date input default
            return date.toISOString().split('T')[0];
        }
        // END: (8.5) Get ISO Date

        // START: (8.6) Calculate Next Due Date
        function calculateNextDueDate(startDate, frequency) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today
            
            let nextDate = new Date(startDate.getTime()); // Clone start date
            
            if (nextDate >= today && frequency === 'once') {
                return nextDate;
            }
            if (nextDate < today && frequency === 'once') {
                return null; // One-time, already passed
            }

            // Loop to find the next date on or after today
            while (nextDate < today) {
                switch (frequency) {
                    case 'weekly':
                        nextDate.setDate(nextDate.getDate() + 7);
                        break;
                    case 'biweekly':
                        nextDate.setDate(nextDate.getDate() + 14);
                        break;
                    case 'monthly':
                        nextDate.setMonth(nextDate.getMonth() + 1);
                        break;
                    case 'quarterly':
                        nextDate.setMonth(nextDate.getMonth() + 3);
                        break;
                    case 'yearly':
                        nextDate.setFullYear(nextDate.getFullYear() + 1);
                        break;
                    default:
                        return null; // Should not happen
                }
            }
            return nextDate;
        }
        // END: (8.6) Calculate Next Due Date

        // START: (8.7) Get Frequency Label
        function getFrequencyLabel(frequency) {
            const labels = {
                once: 'One Time',
                weekly: 'Weekly',
                biweekly: 'Every 2 Weeks',
                monthly: 'Monthly',
                quarterly: 'Quarterly',
                yearly: 'Yearly',
            };
            return labels[frequency] || 'N/A';
        }
        // END: (8.7) Get Frequency Label

        // START: (8.8) Is Asset
        function isAsset(account) {
            if (!account) return false;
            // V3.0: Retirement is also an asset
            return account.type !== 'credit' && account.type !== 'loan';
        }
        // END: (8.8) Is Asset
        
        // =================================================================
        // (END 8.0)
        // =================================================================


        // =================================================================
        // (9.0) PAGE RENDER FUNCTIONS
        // =================================================================
        
        // START: (9.1) Render Dashboard
        function renderDashboard() {
            if (!userId) return; // V1.9
            
            // V2.1: Key Metrics
            let totalAssets = 0;
            let totalLiabilities = 0;
            
            userAccounts.forEach(acc => {
                const balance = parseFloat(acc.balance);
                if (isAsset(acc)) { // V3.0: Use helper
                    totalAssets += balance;
                } else {
                    totalLiabilities += balance;
                }
            });
            const netWorth = totalAssets - totalLiabilities;
            
            if (dashboardNetWorth) dashboardNetWorth.textContent = formatCurrency(netWorth);
            if (dashboardTotalAssets) dashboardTotalAssets.textContent = formatCurrency(totalAssets);
            if (dashboardTotalLiabilities) dashboardTotalLiabilities.textContent = formatCurrency(totalLiabilities);
            
            // --- V2.7: Monthly Spending & Remaining Calculations ---
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            // 1. Calculate ACTUAL spending for the chart (we still need this)
            let monthSpending = 0;
            const spendingByCategory = {};
            userTransactions.forEach(tx => {
                if (tx.type === 'expense' && tx.date >= firstDayOfMonth && tx.date <= lastDayOfMonth) {
                    monthSpending += tx.amount;
                    spendingByCategory[tx.category] = (spendingByCategory[tx.category] || 0) + tx.amount;
                }
            });
            // (Note: dashboardMonthSpending element was removed, so we just pass data to the chart)

            // 2. Calculate PROJECTED remaining to spend
            let projectedIncome = 0;
            let projectedBills = 0;

            userScheduledItems.forEach(item => {
                const nextDueDate = calculateNextDueDate(item.startDate, item.recurring);
                
                // Check if the next due date is valid and falls within the current month
                if (nextDueDate && nextDueDate >= firstDayOfMonth && nextDueDate <= lastDayOfMonth) {
                    if (item.type === 'income') {
                        projectedIncome += item.amount;
                    } else if (item.type === 'bill') {
                        // V3.0.4: FIX - Corrected typo from projectBILLS to projectedBills
                        projectedBills += item.amount;
                    }
                }
            });

            const remainingToSpend = projectedIncome - projectedBills;
            
            // Find the new element from Update 1
            if (dashboardRemaining) dashboardRemaining.textContent = formatCurrency(remainingToSpend);
            
            // --- End V2.7 ---
            
            // V2.1: Render Spending Chart
            renderSpendingChart(spendingByCategory);
            
            // V3.0: Render Net Worth Chart
            renderNetWorthChart(netWorth); // Pass current net worth

            // V2.1: Render Upcoming Widget
            renderDashboardUpcomingWidget();

            // V2.8: Removed renderDashboardBudgets()
        }
        // END: (9.1) Render Dashboard

        // START: (9.2) Render Spending Chart
        function renderSpendingChart(spendingData) {
            const ctx = document.getElementById('spendingChart');
            if (!ctx) return;
            
            const labels = Object.keys(spendingData);
            const data = Object.values(spendingData);
            
            // V2.1: Generate random colors for chart
            const backgroundColors = labels.map(() => 
                `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.6)`
            );
            
            if (spendingChart) {
                spendingChart.destroy();
            }
            
            if (labels.length === 0) {
                // V2.1: Show placeholder
                const placeholder = document.getElementById('spendingChartPlaceholder');
                if (placeholder) {
                    placeholder.classList.remove('hidden');
                } else if (!document.getElementById('spendingChartPlaceholder')) {
                    // V3.0: Check if canvas exists before replacing
                    const canvas = document.getElementById('spendingChart');
                    if (canvas && canvas.parentElement) {
                        canvas.parentElement.innerHTML = '<p id="spendingChartPlaceholder" class="text-center text-gray-500 dark:text-gray-400" style="height: 300px; display: flex; align-items: center; justify-content: center;">No spending data for this month yet.</p><canvas id="spendingChart" class="hidden"></canvas>';
                    }
                }
                return;
            } else {
                // V2.1: Ensure canvas is visible
                const placeholder = document.getElementById('spendingChartPlaceholder');
                if (placeholder) {
                    placeholder.classList.add('hidden');
                }
                ctx.classList.remove('hidden');
            }
            
            spendingChart = new Chart(document.getElementById('spendingChart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Spending',
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
                            }
                        }
                    }
                }
            });
        }
        // END: (9.2) Render Spending Chart     
/* START: (9.3) Render Net Worth Chart (V3.0) */
        function renderNetWorthChart(currentNetWorth) {
            const ctx = document.getElementById('netWorthChart');
            if (!ctx) return;
            
            /* Calculate historical data */
            const labels = [];
            const data = [];
            const daysToTrack = 30;
            
            for (let i = daysToTrack - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(23, 59, 59, 999); /* End of this day */
                
                let netWorthForDay = currentNetWorth;
                
                /* Loop through transactions that happened *after* this day */
                userTransactions.forEach(tx => {
                    if (tx.date > date) {
                        /* "Undo" the transaction */
                        if (tx.type === 'expense') {
                            netWorthForDay += tx.amount;
                        } else if (tx.type === 'income') {
                            netWorthForDay -= tx.amount;
                        } else if (tx.type === 'transfer') {
                            const fromAcc = userAccounts.find(a => a.id === tx.accountId);
                            const toAcc = userAccounts.find(a => a.id === tx.accountIdTo);
                            
                            if (fromAcc && toAcc) {
                                const fromIsAsset = isAsset(fromAcc);
                                const toIsAsset = isAsset(toAcc);
                                
                                /* Checking -> Credit Card (Asset -> Liability) */
                                /* Net worth *increased* by tx.amount. To undo, we *subtract*. */
                                if (fromIsAsset && !toIsAsset) {
                                    netWorthForDay -= tx.amount;
                                }
                                /* Credit Card -> Checking (Liability -> Asset) */
                                /* Net worth *decreased* by tx.amount. To undo, we *add*. */
                                else if (!fromIsAsset && toIsAsset) {
                                    netWorthForDay += tx.amount;
                                }
                            }
                        }
                    }
                });
                
                labels.push(formatDateShort(date));
                data.push(netWorthForDay);
            }
            
            /* Destroy old chart if it exists */
            if (netWorthChart) {
                netWorthChart.destroy();
            }
            
            /* Render new chart */
            netWorthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Net Worth',
                        data: data,
                        borderColor: 'rgba(59, 130, 246, 1)', /* bg-blue-500 */
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Net Worth: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value, index, ticks) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        /* END: (9.3) Render Net Worth Chart (V3.0) */

        /* START: (9.4) Render Accounts Page */
        function renderAccountsPage() {
            if (!accountList) return;
            accountList.innerHTML = "";
            
            if (userAccounts.length === 0) {
                if(accountListPlaceholder) accountListPlaceholder.classList.remove('hidden');
                return;
            }
            
            if(accountListPlaceholder) accountListPlaceholder.classList.add('hidden');
            
            userAccounts.forEach(account => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col justify-between';
                
                const balanceColor = isAsset(account) ? 'text-green-600' : 'text-red-600';
                
                card.innerHTML = `
                    <div>
                        <h3 class="text-xl font-semibold">${account.name}</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 capitalize">${account.type}</p>
                    </div>
                    <p class="text-3xl font-bold my-4 ${balanceColor}">${formatCurrency(account.balance)}</p>
                    <div class="flex gap-2">
                        <button class="edit-account-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-3 rounded-lg text-sm" data-id="${account.id}">Edit</button>
                        <button class="delete-account-btn flex-1 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 font-medium py-2 px-3 rounded-lg text-sm" data-id="${account.id}" data-name="${account.name}">Delete</button>
                    </div>
                `;
                
                accountList.appendChild(card);
            });
            
            /* Add listeners for edit buttons */
            document.querySelectorAll('.edit-account-btn').forEach(btn => {
                btn.onclick = () => handleEditAccount(btn.dataset.id);
            });
            
            /* Delete buttons are now handled by the global listener (see bottom of script) */
        }
        /* END: (9.4) Render Accounts Page */

        /* START: (9.5) Render Transactions Page */
        function renderTransactionsPage() {
            if (!transactionList) return;
            transactionList.innerHTML = "";
            
            /* Get filter values */
            const searchQuery = filterSearch ? filterSearch.value.toLowerCase() : "";
            const selectedAccount = filterAccount ? filterAccount.value : "all";
            const selectedCategory = filterCategory ? filterCategory.value : "all";
            const selectedType = filterType ? filterType.value : "all";
            
            /* Filter transactions */
            const filteredTransactions = userTransactions.filter(tx => {
                const searchMatch = tx.description.toLowerCase().includes(searchQuery);
                let accountMatch = selectedAccount === 'all';
                if (!accountMatch) {
                    if (tx.type === 'transfer') {
                        accountMatch = tx.accountId === selectedAccount || tx.accountIdTo === selectedAccount;
                    } else {
                        accountMatch = tx.accountId === selectedAccount;
                    }
                }
                const categoryMatch = selectedCategory === 'all' || (tx.category && tx.category === selectedCategory);
                const typeMatch = selectedType === 'all' || tx.type === selectedType;
                return searchMatch && accountMatch && categoryMatch && typeMatch;
            });
            
            if (filteredTransactions.length === 0) {
                if(transactionListPlaceholder) transactionListPlaceholder.classList.remove('hidden');
                return;
            }
            
            if(transactionListPlaceholder) transactionListPlaceholder.classList.add('hidden');
            
            filteredTransactions.forEach(tx => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                
                let amountHtml = '';
                let accountHtml = '';
                const account = userAccounts.find(a => a.id === tx.accountId);
                
                if (tx.type === 'transfer') {
                    const toAccount = userAccounts.find(a => a.id === tx.accountIdTo);
                    amountHtml = `<td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium">${formatCurrency(tx.amount)}</td>`;
                    accountHtml = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        From: ${account ? account.name : 'N/A'}<br>
                        To: ${toAccount ? toAccount.name : 'N/A'}
                    </td>`;
                } else {
                    const amountColor = tx.type === 'income' ? 'text-green-600' : 'text-red-600';
                    const amountPrefix = tx.type === 'income' ? '+' : '-';
                    amountHtml = `<td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${amountColor}">${amountPrefix}${formatCurrency(tx.amount)}</td>`;
                    accountHtml = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${account ? account.name : 'N/A'}</td>`;
                }
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${formatDate(tx.date)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${tx.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${tx.category || 'Transfer'}</td>
                    ${accountHtml}
                    ${amountHtml}
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-tx-btn text-blue-600 dark:text-blue-500 hover:underline" data-id="${tx.id}">Edit</button>
                    </td>
                `;
                transactionList.appendChild(tr);
            });
            
            /* Add listeners for edit buttons */
            document.querySelectorAll('.edit-tx-btn').forEach(btn => {
                btn.onclick = () => handleEditTransaction(btn.dataset.id);
            });
        }
        /* END: (9.5) Render Transactions Page */

        /* V2.8: Removed renderBudgetsPage() */
        
        /* START: (9.6) Render Scheduled Page (Controller) */
        function renderScheduledPage() {
            if (!scheduledListView || !scheduledCalendarView) return;
            if (scheduledListView.offsetParent === null) {
                renderScheduledCalendar();
            } else {
                renderScheduledList();
            }
        }
        /* END: (9.6) Render Scheduled Page (Controller) */
        
        /* START: (9.7) Render Scheduled Page - List View */
        function renderScheduledList() {
            if (!scheduledBillsList || !scheduledIncomeList) return;
            scheduledBillsList.innerHTML = "";
            scheduledIncomeList.innerHTML = "";
            
            let billCount = 0;
            let incomeCount = 0;
            
            userScheduledItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-4';
                
                const nextDueDate = calculateNextDueDate(item.startDate, item.recurring);
                const nextDateStr = nextDueDate ? `Next: ${formatDate(nextDueDate)}` : 'One-time (Past)';
                
                li.innerHTML = `
                    <div>
                        <p class="font-medium">${item.description}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            ${getFrequencyLabel(item.recurring)} (${item.category})
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${nextDateStr}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-medium ${item.type === 'bill' ? 'text-red-600' : 'text-green-600'}">
                            ${formatCurrency(item.amount)}
                        </p>
                        <div>
                            <button class="edit-scheduled-btn text-blue-600 dark:text-blue-500 hover:underline text-sm" data-id="${item.id}">Edit</button>
                            <button class="delete-scheduled-btn text-red-600 dark:text-red-500 hover:underline text-sm ml-2" data-id="${item.id}">Delete</button>
                        </div>
                    </div>
                `;
                
                if (item.type === 'bill') {
                    scheduledBillsList.appendChild(li);
                    billCount++;
                } else {
                    scheduledIncomeList.appendChild(li);
                    incomeCount++;
                }
            });
            
            /* Add listeners */
            document.querySelectorAll('.edit-scheduled-btn').forEach(btn => {
                btn.onclick = () => handleEditScheduledItem(btn.dataset.id);
            });

            document.querySelectorAll('.delete-scheduled-btn').forEach(btn => {
                btn.onclick = () => handleDeleteScheduledItem(btn.dataset.id);
            });
            
            /* Show placeholders if empty */
            if(scheduledBillsPlaceholder) scheduledBillsPlaceholder.classList.toggle('hidden', billCount > 0);
            if(scheduledIncomePlaceholder) scheduledIncomePlaceholder.classList.toggle('hidden', incomeCount > 0);
        }
        /* END: (9.7) Render Scheduled Page - List View */

        /* START: (9.8) Render Scheduled Page - Calendar View */
        function renderScheduledCalendar() {
            if (!calendarDaysGrid || !calendarMonthYear) return;
            calendarDaysGrid.innerHTML = "";
            calendarMonthYear.textContent = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDayOfMonth.getDay(); /* 0 = Sunday, 1 = Monday, ... */
            const lastDateOfMonth = lastDayOfMonth.getDate();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            /* 1. Get days from previous month */
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            for (let i = firstDayOfWeek; i > 0; i--) {
                const day = daysInPrevMonth - i + 1;
                const cell = document.createElement('div');
                cell.className = 'calendar-day other-month p-2 border dark:border-gray-700';
                cell.innerHTML = `<div class="day-number">${day}</div>`;
                calendarDaysGrid.appendChild(cell);
            }

            /* 2. Get days for current month */
            for (let day = 1; day <= lastDateOfMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day p-2 border dark:border-gray-700';
                
                const date = new Date(year, month, day);
                const isToday = date.getTime() === today.getTime();
                
                cell.innerHTML = `<div class="day-number ${isToday ? 'today' : ''}">${day}</div>`;
                
                /* Find items for this day */
                const itemsForDay = userScheduledItems.map(item => {
                    const nextDueDate = calculateNextDueDate(item.startDate, item.recurring);
                    return { ...item, nextDueDate };
                }).filter(item => {
                    return item.nextDueDate && 
                           item.nextDueDate.getFullYear() === year &&
                           item.nextDueDate.getMonth() === month &&
                           item.nextDueDate.getDate() === day;
                }).sort((a,b) => a.amount - b.amount); /* Show smaller items first */

                itemsForDay.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = `calendar-item ${item.type === 'bill' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
                    itemEl.title = `${item.description} - ${formatCurrency(item.amount)}`;
                    itemEl.textContent = item.description;
                    cell.appendChild(itemEl);
                });

                calendarDaysGrid.appendChild(cell);
            }
            
            /* 3. Get days for next month */
            const lastDayOfWeek = lastDayOfMonth.getDay();
            for (let i = 1; i < 7 - lastDayOfWeek; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day other-month p-2 border dark:border-gray-700';
                cell.innerHTML = `<div class="day-number">${i}</div>`;
                calendarDaysGrid.appendChild(cell);
            }
        }
        /* END: (9.8) Render Scheduled Page - Calendar View */
        
        /* START: (9.9) Populate Filter/Modal Options */
        function populateAccountOptions() {
            const selects = [
                document.getElementById('transactionAccount'),
                document.getElementById('transactionAccountTo'),
                document.getElementById('filterAccount')
            ];
            
            selects.forEach(select => {
                if (!select) return;
                const firstOption = select.options[0];
                select.innerHTML = "";
                select.appendChild(firstOption);
                
                userAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.name} (${formatCurrency(account.balance)})`;
                    select.appendChild(option);
                });
            });
        }
        
        function populateCategoryOptions() {
            /* 1. Used in Transaction filters */
            const select = document.getElementById('filterCategory');
            if (select) {
                const firstOption = select.options[0]; /* "All Categories" */
                select.innerHTML = "";
                select.appendChild(firstOption);
                
                const allCategories = [...userExpenseCategories, ...userIncomeCategories];
                const uniqueNames = [...new Set(allCategories.map(c => c.name))].sort();
                
                uniqueNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });
            }
            
            /* 2. Used in Transaction modal */
            const txCategorySelect = document.getElementById('transactionCategory');
            if (txCategorySelect) {
                updateTransactionCategoryOptions(txCategorySelect, 'expense'); /* Default to expense */
            }
            
            /* 3. Used in Scheduled Item modal */
            updateScheduledCategoryOptions('bill'); /* Default to bill */
        }
        /* END: (9.9) Populate Filter/Modal Options */

        /* START: (9.10) Update Transaction Category Options */
        function updateTransactionCategoryOptions(selectElement, type) {
            if (!selectElement) return;
            selectElement.innerHTML = ""; /* Clear existing */
            const categories = (type === 'income') ? userIncomeCategories : userExpenseCategories;
            categories.sort((a,b) => a.name.localeCompare(b.name)).forEach(category => {
                const option = document.createElement('option');
                option.value = category.name; /* Use the name as the value */
                option.textContent = category.name;
                selectElement.appendChild(option);
            });
        }
        /* END: (9.10) Update Transaction Category Options */
        
        /* START: (9.11) Update Scheduled Category Options */
        function updateScheduledCategoryOptions(type) {
            const selectElement = document.getElementById('scheduledCategory');
            if (!selectElement) return;
            selectElement.innerHTML = ""; /* Clear existing */
            const categories = (type === 'income') ? userIncomeCategories : userExpenseCategories;
            categories.sort((a,b) => a.name.localeCompare(b.name)).forEach(category => {
                const option = document.createElement('option');
                option.value = category.name; /* Use the name as the value */
                option.textContent = category.name;
                selectElement.appendChild(option);
            });
        }
        /* END: (9.11) Update Scheduled Category Options */
        
        /* ================================================================= */
        /* (END 9.0) */
        /* ================================================================= */
 /* ================================================================= */
        /* (10.0) TRANSACTION MODAL LOGIC (V3.0) */
        /* ================================================================= */

        /* START: (10.1) Open Transaction Modal Listeners */
        if (quickAddTxBtn) {
            quickAddTxBtn.addEventListener('click', () => {
                openTransactionModal();
            });
        }
        
        if (addTransactionBtn) {
            addTransactionBtn.addEventListener('click', () => {
                openTransactionModal();
            });
        }
        
        if (cancelTransactionBtn) {
            cancelTransactionBtn.addEventListener('click', () => {
                closeModal(transactionModal);
            });
        }
        /* END: (10.1) Open Transaction Modal Listeners */

        /* START: (10.2) Open Transaction Modal (Main) */
        function openTransactionModal(txId = null) {
            if (!transactionModal) return;
            transactionForm.reset();
            
            /* V3.0: Default to 'expense' */
            setTransactionType('expense');
            
            if (txId) {
                /* --- Edit Mode --- */
                transactionModalTitle.textContent = "Edit Transaction";
                document.getElementById('transactionId').value = txId;
                if (deleteTransactionBtn) deleteTransactionBtn.classList.remove('hidden');
                
                const tx = userTransactions.find(t => t.id === txId);
                if (tx) {
                    setTransactionType(tx.type); /* V3.0 */
                    document.getElementById('transactionDescription').value = tx.description;
                    document.getElementById('transactionAmount').value = tx.amount;
                    document.getElementById('transactionDate').value = getISODate(tx.date);
                    document.getElementById('transactionAccount').value = tx.accountId;
                    
                    if (tx.type === 'transfer') {
                        document.getElementById('transactionAccountTo').value = tx.accountIdTo;
                    } else {
                        document.getElementById('transactionCategory').value = tx.category;
                    }
                }
            } else {
                /* --- Add Mode --- */
                transactionModalTitle.textContent = "Add Transaction";
                document.getElementById('transactionId').value = "";
                if (deleteTransactionBtn) deleteTransactionBtn.classList.add('hidden');
                document.getElementById('transactionDate').value = getISODate();
            }
            
            openModal(transactionModal);
        }
        /* END: (10.2) Open Transaction Modal (Main) */
        
        /* START: (10.3) Handle Edit Transaction Click */
        function handleEditTransaction(txId) {
            openTransactionModal(txId);
        }
        /* END: (10.3) Handle Edit Transaction Click */
        
        /* START: (10.4) Transaction Type Toggle */
        if (txTypeExpense) txTypeExpense.addEventListener('click', () => setTransactionType('expense'));
        if (txTypeIncome) txTypeIncome.addEventListener('click', () => setTransactionType('income'));
        if (txTypeTransfer) txTypeTransfer.addEventListener('click', () => setTransactionType('transfer'));
        
        function setTransactionType(type) {
            const fromLabel = document.querySelector('#txFromAccountWrapper label');
            
            /* Reset all styles */
            [txTypeExpense, txTypeIncome, txTypeTransfer].forEach(btn => {
                if (btn) {
                    btn.classList.remove('bg-red-600', 'bg-green-600', 'bg-blue-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
                }
            });

            if (type === 'income') {
                if(txTypeIncome) {
                    txTypeIncome.classList.add('bg-green-600', 'text-white');
                    txTypeIncome.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                }
                if(txCategoryWrapper) txCategoryWrapper.classList.remove('hidden');
                if(txToAccountWrapper) txToAccountWrapper.classList.add('hidden');
                if(transactionAccountTo) transactionAccountTo.required = false;
                if(transactionCategory) transactionCategory.required = true;
                if(fromLabel) fromLabel.textContent = "Account";
                updateTransactionCategoryOptions(transactionCategory, 'income');
                
            } else if (type === 'transfer') {
                if(txTypeTransfer) {
                    txTypeTransfer.classList.add('bg-blue-600', 'text-white');
                    txTypeTransfer.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                }
                if(txCategoryWrapper) txCategoryWrapper.classList.add('hidden');
                if(txToAccountWrapper) txToAccountWrapper.classList.remove('hidden');
                if(transactionAccountTo) transactionAccountTo.required = true;
                if(transactionCategory) transactionCategory.required = false;
                if(fromLabel) fromLabel.textContent = "From Account";
                
            } else { /* 'expense' */
                if(txTypeExpense) {
                    txTypeExpense.classList.add('bg-red-600', 'text-white');
                    txTypeExpense.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                }
                if(txCategoryWrapper) txCategoryWrapper.classList.remove('hidden');
                if(txToAccountWrapper) txToAccountWrapper.classList.add('hidden');
                if(transactionAccountTo) transactionAccountTo.required = false;
                if(transactionCategory) transactionCategory.required = true;
                if(fromLabel) fromLabel.textContent = "Account";
                updateTransactionCategoryOptions(transactionCategory, 'expense');
            }
            
            /* Store the currently active type */
            if(transactionForm) transactionForm.dataset.type = type;
        }
        
        function getTransactionType() {
            return transactionForm.dataset.type || 'expense';
        }
        /* END: (10.4) Transaction Type Toggle */

        /* START: (10.5) Save Transaction Form */
        if (transactionForm) {
            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId) return;
                
                const txId = document.getElementById('transactionId').value;
                const type = getTransactionType();
                
                /* Get original tx data for balance calculations */
                const originalTx = txId ? userTransactions.find(t => t.id === txId) : null;

                /* Prepare new tx data */
                const newTxData = {
                    description: document.getElementById('transactionDescription').value,
                    amount: parseFloat(document.getElementById('transactionAmount').value),
                    date: Timestamp.fromDate(new Date(document.getElementById('transactionDate').value + 'T12:00:00')),
                    type: type,
                    accountId: document.getElementById('transactionAccount').value,
                    accountIdTo: type === 'transfer' ? document.getElementById('transactionAccountTo').value : null,
                    category: type !== 'transfer' ? document.getElementById('transactionCategory').value : null
                };
                
                if (type === 'transfer' && newTxData.accountId === newTxData.accountIdTo) {
                    openDeleteModal("Cannot transfer to the same account.", () => {}, true);
                    return;
                }

                const batch = writeBatch(db);
                
                try {
                    if (txId) {
                        /* --- Update Existing Transaction --- */
                        const txRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, txId);
                        
                        /* 1. Revert original balances */
                        if (originalTx.type === 'transfer') {
                            const oldFrom = userAccounts.find(a => a.id === originalTx.accountId);
                            const oldTo = userAccounts.find(a => a.id === originalTx.accountIdTo);
                            if(oldFrom) batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, oldFrom.id), { balance: oldFrom.balance + originalTx.amount });
                            if(oldTo) batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, oldTo.id), { balance: oldTo.balance - originalTx.amount });
                        } else { /* income or expense */
                            const oldAcc = userAccounts.find(a => a.id === originalTx.accountId);
                            if(oldAcc) batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, oldAcc.id), { balance: oldAcc.balance - (originalTx.type === 'income' ? originalTx.amount : -originalTx.amount) });
                        }
                        
                        /* 2. Apply new balances */
                        if (newTxData.type === 'transfer') {
                            const newFrom = userAccounts.find(a => a.id === newTxData.accountId);
                            const newTo = userAccounts.find(a => a.id === newTxData.accountIdTo);
                            if(newFrom) batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, newFrom.id), { balance: newFrom.balance - newTxData.amount });
                            if(newTo) batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, newTo.id), { balance: newTo.balance + newTxData.amount });
                        } else { /* income or expense */
                            const newAcc = userAccounts.find(a => a.id === newTxData.accountId);
                            if(newAcc) batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, newAcc.id), { balance: newAcc.balance + (newTxData.type === 'income' ? newTxData.amount : -newTxData.amount) });
                        }
                        
                        /* 3. Update the transaction doc itself */
                        batch.update(txRef, newTxData);

                    } else {
                        /* --- Add New Transaction --- */
                        const newTxRef = doc(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                        batch.set(newTxRef, newTxData);
                        
                        /* Update account balance(s) */
                        if (type === 'transfer') {
                            const fromAcc = userAccounts.find(a => a.id === newTxData.accountId);
                            const toAcc = userAccounts.find(a => a.id === newTxData.accountIdTo);
                            if (fromAcc) batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, fromAcc.id), { balance: fromAcc.balance - newTxData.amount });
                            if (toAcc) batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, toAcc.id), { balance: toAcc.balance + newTxData.amount });
                        } else { /* income or expense */
                            const acc = userAccounts.find(a => a.id === newTxData.accountId);
                            const newBalance = acc.balance + (type === 'income' ? newTxData.amount : -newTxData.amount);
                            batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, acc.id), { balance: newBalance });
                        }
                    }
                    
                    await batch.commit(); /* V1.9: Commit the batch */
                    closeModal(transactionModal);
                    
                } catch (error) {
                    console.error("Error saving transaction:", error);
                    openDeleteModal("Error: " + error.message, () => {}, true);
                }
            });
        }
        /* END: (10.5) Save Transaction Form */

        /* START: (10.6) Delete Transaction Button */
        if (deleteTransactionBtn) {
            deleteTransactionBtn.addEventListener('click', async () => {
                if (!userId) return;
                const txId = document.getElementById('transactionId').value;
                if (!txId) return;
                
                const txToDelete = userTransactions.find(t => t.id === txId);
                
                openDeleteModal("Are you sure you want to delete this transaction?", async () => {
                    console.log("DEBUG: Deleting transaction", txId);
                    const txRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, txId);
                    const batch = writeBatch(db);
                    
                    try {
                        /* 1. Delete the transaction */
                        batch.delete(txRef);
                        
                        /* 2. Revert account balance(s) */
                        if (txToDelete.type === 'transfer') {
                            const fromAcc = userAccounts.find(a => a.id === txToDelete.accountId);
                            const toAcc = userAccounts.find(a => a.id === txToDelete.accountIdTo);
                            if (fromAcc) batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, fromAcc.id), { balance: fromAcc.balance + txToDelete.amount });
                            if (toAcc) batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, toAcc.id), { balance: toAcc.balance - txToDelete.amount });
                        } else { /* income or expense */
                            const acc = userAccounts.find(a => a.id === txToDelete.accountId);
                            if (acc) {
                                const newBalance = acc.balance - (txToDelete.type === 'income' ? txToDelete.amount : -txToDelete.amount);
                                batch.update(doc(db, `artifacts/${appId}/users/${userId}/accounts`, acc.id), { balance: newBalance });
                            }
                        }
                        
                        await batch.commit();
                        closeModal(transactionModal);
                        
                    } catch (error) {
                        console.error("Error deleting transaction:", error);
                        openDeleteModal("Error: " + error.message, () => {}, true);
                    }
                });
            });
        }
        /* END: (10.6) Delete Transaction Button */
        
        /* ================================================================= */
        /* (END 10.0) */
        /* ================================================================= */


        /* ================================================================= */
        /* (11.0) ACCOUNT MODAL LOGIC */
        /* ================================================================= */
        
        /* START: (11.1) Open Account Modal Listeners */
        if (quickAddAccountBtn) quickAddAccountBtn.addEventListener('click', () => openAccountModal());
        if (addAccountBtn) addAccountBtn.addEventListener('click', () => openAccountModal());
        if (cancelAccountBtn) cancelAccountBtn.addEventListener('click', () => closeModal(accountModal));
        /* END: (11.1) Open Account Modal Listeners */

        /* START: (11.2) Open Account Modal (Main) */
        function openAccountModal(accId = null) {
            if (!accountModal) return;
            accountForm.reset();
            const balanceInput = document.getElementById('accountBalance');
            
            if (accId) {
                /* --- Edit Mode --- */
                accountModalTitle.textContent = "Edit Account";
                document.getElementById('accountId').value = accId;
                const acc = userAccounts.find(a => a.id === accId);
                if (acc) {
                    document.getElementById('accountName').value = acc.name;
                    document.getElementById('accountType').value = acc.type;
                    balanceInput.value = acc.balance;
                }
                
                if (acc && acc.type === 'retirement') {
                    balanceInput.disabled = false;
                    balanceInput.parentElement.classList.remove('hidden');
                } else {
                    balanceInput.disabled = true;
                    balanceInput.parentElement.classList.add('hidden');
                }
                
            } else {
                /* --- Add Mode --- */
                accountModalTitle.textContent = "Add Account";
                document.getElementById('accountId').value = "";
                balanceInput.disabled = false;
                balanceInput.parentElement.classList.remove('hidden');
            }
            
            openModal(accountModal);
        }
        /* END: (11.2) Open Account Modal (Main) */
        
        /* START: (11.3) Handle Edit Account Click */
        function handleEditAccount(accId) {
            openAccountModal(accId);
        }
        /* END: (11.3) Handle Edit Account Click */

        /* START: (11.4) Save Account Form */
        if (accountForm) {
            accountForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId) return;
                
                const accId = document.getElementById('accountId').value;
                const accData = {
                    name: document.getElementById('accountName').value,
                    type: document.getElementById('accountType').value,
                };
                
                try {
                    if (accId) {
                        /* --- Update Existing Account --- */
                        const accRef = doc(db, `artifacts/${appId}/users/${userId}/accounts`, accId);
                        const updateData = { name: accData.name, type: accData.type };

                        const balanceInput = document.getElementById('accountBalance');
                        if (!balanceInput.disabled) {
                            updateData.balance = parseFloat(balanceInput.value) || 0;
                        }
                        await updateDoc(accRef, updateData);
                        
                    } else {
                        /* --- Add New Account --- */
                        accData.balance = parseFloat(document.getElementById('accountBalance').value) || 0;
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/accounts`), accData);
                    }
                    
                    closeModal(accountModal);
                    
                } catch (error) {
                    console.error("Error saving account:", error);
                    openDeleteModal("Error: " + error.message, () => {}, true);
                }
            });
        }
        /* END: (11.4) Save Account Form */
        
        /* ================================================================= */
        /* (END 11.0) */
        /* ================================================================= */
        
        
        /* ================================================================= */
        /* (12.0) SCHEDULED ITEM MODAL LOGIC */
        /* ================================================================= */
        
        /* START: (12.1) Open Scheduled Item Modal Listeners */
        if(quickAddScheduledBtn) quickAddScheduledBtn.addEventListener('click', () => openScheduledItemModal());
        if(addScheduledItemBtn) addScheduledItemBtn.addEventListener('click', () => openScheduledItemModal());
        if(cancelScheduledItemBtn) cancelScheduledItemBtn.addEventListener('click', () => closeModal(scheduledItemModal));
        /* END: (12.1) Open Scheduled Item Modal Listeners */

        /* START: (12.2) Open Scheduled Item Modal (Main) */
        function openScheduledItemModal(itemId = null) {
            if(!scheduledItemModal) return;
            scheduledItemForm.reset();
            setScheduledItemType('bill');
            
            if (itemId) {
                /* --- Edit Mode --- */
                scheduledItemModalTitle.textContent = "Edit Scheduled Item";
                document.getElementById('scheduledItemId').value = itemId;
                
                const item = userScheduledItems.find(i => i.id === itemId);
                if (item) {
                    setScheduledItemType(item.type);
                    document.getElementById('scheduledDescription').value = item.description;
                    document.getElementById('scheduledAmount').value = item.amount;
                    document.getElementById('scheduledStartDate').value = getISODate(item.startDate);
                    document.getElementById('scheduledRecurring').value = item.recurring;
                    document.getElementById('scheduledCategory').value = item.category;
                }
            } else {
                /* --- Add Mode --- */
                scheduledItemModalTitle.textContent = "Add Scheduled Item";
                document.getElementById('scheduledItemId').value = "";
                document.getElementById('scheduledStartDate').value = getISODate();
            }
            
            openModal(scheduledItemModal);
        }
        /* END: (12.2) Open Scheduled Item Modal (Main) */
        
        /* START: (12.3) Handle Edit Scheduled Item Click */
        function handleEditScheduledItem(itemId) {
            openScheduledItemModal(itemId);
        }
        /* END: (12.3) Handle Edit Scheduled Item Click */

        /* START: (12.4) Scheduled Item Type Toggle */
        if(scheduledTypeBill) scheduledTypeBill.addEventListener('click', () => setScheduledItemType('bill'));
        if(scheduledTypeIncome) scheduledTypeIncome.addEventListener('click', () => setScheduledItemType('income'));
        
        function setScheduledItemType(type) {
            if (type === 'income') {
                if(scheduledTypeIncome) {
                    scheduledTypeIncome.classList.add('bg-green-600', 'text-white');
                    scheduledTypeIncome.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                }
                if(scheduledTypeBill) {
                    scheduledTypeBill.classList.add('bg-gray-200', 'dark:bg-gray-700');
                    scheduledTypeBill.classList.remove('bg-red-600', 'text-white');
                }
                updateScheduledCategoryOptions('income');
                if(scheduledTypeIncome) scheduledTypeIncome.dataset.type = 'income';
            } else { /* 'bill' */
                if(scheduledTypeBill) {
                    scheduledTypeBill.classList.add('bg-red-600', 'text-white');
                    scheduledTypeBill.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                }
                if(scheduledTypeIncome) {
                    scheduledTypeIncome.classList.add('bg-gray-200', 'dark:bg-gray-700');
                    scheduledTypeIncome.classList.remove('bg-green-600', 'text-white');
                }
                updateScheduledCategoryOptions('expense');
                if(scheduledTypeBill) scheduledTypeBill.dataset.type = 'bill';
            }
        }
        
        function getScheduledItemType() {
            return scheduledTypeIncome.dataset.type === 'income' ? 'income' : 'bill';
        }
        /* END: (12.4) Scheduled Item Type Toggle */

        /* START: (12.5) Save Scheduled Item Form */
        if(scheduledItemForm) {
            scheduledItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId) return;
                
                const itemId = document.getElementById('scheduledItemId').value;
                const itemData = {
                    description: document.getElementById('scheduledDescription').value,
                    amount: parseFloat(document.getElementById('scheduledAmount').value),
                    startDate: Timestamp.fromDate(new Date(document.getElementById('scheduledStartDate').value + 'T12:00:00')),
                    recurring: document.getElementById('scheduledRecurring').value,
                    category: document.getElementById('scheduledCategory').value,
                    type: getScheduledItemType()
                };
                
                try {
                    if (itemId) {
                        await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/scheduledItems`, itemId), itemData);
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/scheduledItems`), itemData);
                    }
                    closeModal(scheduledItemModal);
                } catch (error) {
                    console.error("Error saving scheduled item:", error);
                    openDeleteModal("Error: " + error.message, () => {}, true);
                }
            });
        }
        /* END: (12.5) Save Scheduled Item Form */
        
        /* ================================================================= */
        /* (END 12.0) */
        /* ================================================================= */
        
        
        /* ================================================================= */
        /* (13.0) SETTINGS PAGE LOGIC */
        /* ================================================================= */
        
        /* START: (13.1) Export Data */
        if(exportDataBtn) {
            exportDataBtn.addEventListener('click', () => {
                const data = {
                    accounts: userAccounts,
                    transactions: userTransactions,
                    scheduledItems: userScheduledItems,
                    categories: [ ...userExpenseCategories, ...userIncomeCategories ]
                };
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `myfinance_data_${getISODate()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });
        }
        /* END: (13.1) Export Data */
        
        /* START: (13.2) Danger Zone */
        if(dangerZoneToggle) dangerZoneToggle.addEventListener('click', () => dangerZone.classList.toggle('hidden'));
        
        if(deleteAllDataBtn) {
            deleteAllDataBtn.addEventListener('click', () => {
                openDeleteModal("ARE YOU SURE?\n\nThis will delete ALL accounts, transactions, scheduled items, and categories associated with your user ID. This action is permanent and cannot be undone.", async () => {
                    if (!userId) return;
                    
                    console.warn(`WARN: Deleting all data for user ${userId}`);
                    const loadingScreen = document.getElementById('loadingScreen');
                    const mainContent = document.getElementById('mainContent');
                    if(loadingScreen) loadingScreen.classList.remove('hidden');
                    if(mainContent) mainContent.classList.add('hidden');
                    
                    try {
                        const batch = writeBatch(db);
                        
                        const collections = ['accounts', 'transactions', 'scheduledItems', 'categories'];
                        for (const coll of collections) {
                            const snapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/${coll}`));
                            snapshot.forEach(doc => batch.delete(doc.ref));
                        }
                        
                        await batch.commit();
                        console.log("DEBUG: All user data deleted.");
                        location.reload();
                        
                    } catch (error) {
                        console.error("Error deleting all data:", error);
                        openDeleteModal("Error: " + error.message, () => {}, true);
                        if(loadingScreen) loadingScreen.classList.add('hidden');
                        if(mainContent) mainContent.classList.remove('hidden');
                    }
                });
            });
        }
        /* END: (13.2) Danger Zone */

        /* START: (13.3) Category Management */
        async function createDefaultCategories() {
            if (!userId) return;
            const defaultExpenses = ['Food', 'Groceries', 'Restaurants', 'Transport', 'Utilities', 'Rent/Mortgage', 'Insurance', 'Health', 'Entertainment', 'Shopping', 'Subscriptions', 'Travel', 'Education', 'Gifts', 'Other'];
            const defaultIncomes = ['Salary', 'Bonus', 'Freelance', 'Investment', 'Gifts', 'Other'];
            
            const batch = writeBatch(db);
            const catRef = collection(db, `artifacts/${appId}/users/${userId}/categories`);
            
            defaultExpenses.forEach(name => {
                batch.set(doc(catRef), { name: name, type: 'expense' });
            });
            defaultIncomes.forEach(name => {
                batch.set(doc(catRef), { name: name, type: 'income' });
            });
            
            try {
                await batch.commit();
                console.log("DEBUG: Default categories created.");
            } catch (error) {
                console.error("Error creating default categories:", error);
            }
        }
        
        function renderCategorySettings() {
            if(expenseCategoryList) {
                expenseCategoryList.innerHTML = "";
                userExpenseCategories.sort((a,b) => a.name.localeCompare(b.name)).forEach(cat => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded-md";
                    li.innerHTML = `
                        <span class="text-sm font-medium">${cat.name}</span>
                        <button class="delete-category-btn text-red-500 hover:text-red-700" data-id="${cat.id}" data-name="${cat.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    `;
                    expenseCategoryList.appendChild(li);
                });
            }

            if(incomeCategoryList) {
                incomeCategoryList.innerHTML = "";
                userIncomeCategories.sort((a,b) => a.name.localeCompare(b.name)).forEach(cat => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-700 rounded-md";
                    li.innerHTML = `
                        <span class="text-sm font-medium">${cat.name}</span>
                        <button class="delete-category-btn text-red-500 hover:text-red-700" data-id="${cat.id}" data-name="${cat.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    `;
                    incomeCategoryList.appendChild(li);
                });
            }
        }
        
        if(addExpenseCategoryForm) {
            addExpenseCategoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId || !newExpenseCategory.value) return;
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/categories`), {
                        name: newExpenseCategory.value,
                        type: 'expense'
                    });
                    newExpenseCategory.value = "";
                } catch (error) {
                    console.error("Error adding expense category:", error);
                }
            });
        }

        if(addIncomeCategoryForm) {
            addIncomeCategoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId || !newIncomeCategory.value) return;
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/categories`), {
                        name: newIncomeCategory.value,
                        type: 'income'
                    });
                    newIncomeCategory.value = "";
                } catch (error) {
                    console.error("Error adding income category:", error);
                }
            });
        }
        /* END: (13.3) Category Management */

        /* ================================================================= */
        /* (END 13.0) */
        /* ================================================================= */


        /* ================================================================= */
        /* (14.0) GENERAL EVENT LISTENERS */
        /* ================================================================= */
        
        /* START: (14.1) Transaction Filter Listeners */
        if(filterSearch) filterSearch.addEventListener('input', renderTransactionsPage);
        if(filterAccount) filterAccount.addEventListener('change', renderTransactionsPage);
        if(filterCategory) filterCategory.addEventListener('change', renderTransactionsPage);
        if(filterType) filterType.addEventListener('change', renderTransactionsPage);
        
        if(resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', () => {
                if(filterSearch) filterSearch.value = "";
                if(filterAccount) filterAccount.value = 'all';
                if(filterCategory) filterCategory.value = 'all';
                if(filterType) filterType.value = 'all';
                renderTransactionsPage();
            });
        }
        /* END: (14.1) Transaction Filter Listeners */
        
        /* START: (14.2) Scheduled View Toggle */
        function setScheduledView(view) {
            if (view === 'calendar') {
                if(scheduledListView) scheduledListView.classList.add('hidden');
                if(scheduledCalendarView) scheduledCalendarView.classList.remove('hidden');
                if(scheduledViewCalendarBtn) scheduledViewCalendarBtn.classList.add('bg-blue-600', 'text-white');
                if(scheduledViewListBtn) scheduledViewListBtn.classList.remove('bg-blue-600', 'text-white');
                renderScheduledCalendar();
            } else {
                if(scheduledListView) scheduledListView.classList.remove('hidden');
                if(scheduledCalendarView) scheduledCalendarView.classList.add('hidden');
                if(scheduledViewListBtn) scheduledViewListBtn.classList.add('bg-blue-600', 'text-white');
                if(scheduledViewCalendarBtn) scheduledViewCalendarBtn.classList.remove('bg-blue-600', 'text-white');
                renderScheduledList();
            }
        }
        
        if(scheduledViewListBtn) scheduledViewListBtn.addEventListener('click', () => setScheduledView('list'));
        if(scheduledViewCalendarBtn) scheduledViewCalendarBtn.addEventListener('click', () => setScheduledView('calendar'));
        /* END: (14.2) Scheduled View Toggle */

        /* START: (14.3) Calendar Navigation */
        if(calendarPrevMonthBtn) {
            calendarPrevMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderScheduledCalendar();
            });
        }
        if(calendarNextMonthBtn) {
            calendarNextMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderScheduledCalendar();
            });
        }
        /* END: (14.3) Calendar Navigation */

        /* START: (14.4) "Log as Paid" Logic */
        function handleLogAsPaid(scheduledItemId) {
            const item = userScheduledItems.find(i => i.id === scheduledItemId);
            if (!item) {
                console.error("Scheduled item not found!");
                return;
            }
            
            openTransactionModal();
            setTransactionType(item.type === 'bill' ? 'expense' : 'income'); 
            document.getElementById('transactionDescription').value = item.description;
            document.getElementById('transactionAmount').value = item.amount;
            document.getElementById('transactionDate').value = getISODate(); /* Today's date */
            document.getElementById('transactionCategory').value = item.category;
            document.getElementById('transactionAccount').focus();
        }
        /* END: (14.4) "Log as Paid" Logic */

        /* START: (14.5) Render "Upcoming" Widget */
        function renderDashboardUpcomingWidget() {
            if(!dashboardUpcomingList) return;
            dashboardUpcomingList.innerHTML = "";
            let upcomingCount = 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const twoWeeksFromNow = new Date();
            twoWeeksFromNow.setDate(today.getDate() + 14);
            twoWeeksFromNow.setHours(23, 59, 59, 999);

            const upcomingItems = userScheduledItems.map(item => {
                const nextDueDate = calculateNextDueDate(item.startDate, item.recurring);
                return { ...item, nextDueDate };
            }).filter(item => {
                return item.nextDueDate && item.nextDueDate >= today && item.nextDueDate <= twoWeeksFromNow;
            }).sort((a, b) => a.nextDueDate - b.nextDueDate);

            upcomingItems.forEach(item => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700";
                
                const amountFormatted = formatCurrency(item.amount);
                const dateFormatted = formatDateMonthDay(item.nextDueDate);
                const amountColor = item.type === 'bill' ? 'text-red-600' : 'text-green-600';
                
                li.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium">${item.description}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">${dateFormatted}</p>
                    </div>
                    <div class="text-right pr-4">
                        <span class="font-medium ${amountColor}">${amountFormatted}</span>
                    </div>
                    <div class="flex items-center">
                        <button class="log-paid-btn bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800 text-xs font-medium py-1 px-2 rounded-md" data-id="${item.id}">
                            Log
                        </button>
                    </div>
                `;
                
                dashboardUpcomingList.appendChild(li);
                upcomingCount++;
            });

            document.querySelectorAll('.log-paid-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    handleLogAsPaid(btn.dataset.id);
                };
            });
                
            if(dashboardUpcomingPlaceholder) dashboardUpcomingPlaceholder.classList.toggle('hidden', upcomingCount > 0);
        }
        /* END: (14.5) Render "Upcoming" Widget */

        /* START: (14.6) Delete Scheduled Item */
        async function handleDeleteScheduledItem(itemId) {
            if (!userId) return;
            const item = userScheduledItems.find(i => i.id === itemId);
            const itemName = item ? item.description : "this item";
            
            openDeleteModal(`Are you sure you want to delete "${itemName}"? This cannot be undone.`, async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/scheduledItems`, itemId));
                } catch (error) {
                    console.error("Error deleting scheduled item:", error);
                    openDeleteModal("Error: " + error.message, () => {}, true);
                }
            });
        }
        /* END: (14.6) Delete Scheduled Item */
        
        /* START: (14.7) Delete Modal Controls */
        let confirmCallback = null; 
        
        function openDeleteModal(message, onConfirm, isInfoOnly = false) {
            if(!deleteModal) return;
            deleteModalMessage.innerHTML = message.replace(/\n/g, '<br>');
            confirmCallback = onConfirm; 
            
            if (isInfoOnly) {
                if(confirmDeleteBtn) confirmDeleteBtn.classList.add('hidden');
                if(cancelDeleteBtn) cancelDeleteBtn.textContent = 'OK';
            } else {
                if(confirmDeleteBtn) confirmDeleteBtn.classList.remove('hidden');
                if(confirmDeleteBtn) confirmDeleteBtn.textContent = 'Delete';
                if(cancelDeleteBtn) cancelDeleteBtn.textContent = 'Cancel';
            }
            openModal(deleteModal);
        }
        
        function closeDeleteModal() {
            closeModal(deleteModal);
            confirmCallback = null; 
        }
        
        if(cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', closeDeleteModal);
        
        if(confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') {
                    confirmCallback(); 
                }
                closeDeleteModal(); 
            });
        }
        /* END: (14.7) Delete Modal Controls */
        
        /* START: (14.8) Global Click Listener (for Deletes) */
        document.addEventListener('click', async (e) => {
            const deleteAccountBtn = e.target.closest('.delete-account-btn');
            if (deleteAccountBtn) {
                const accountId = deleteAccountBtn.dataset.id;
                const accountName = deleteAccountBtn.dataset.name;
                handleDeleteAccountClick(accountId, accountName);
                return;
            }
            
            const deleteCategoryBtn = e.target.closest('.delete-category-btn');
            if (deleteCategoryBtn) {
                const categoryId = deleteCategoryBtn.dataset.id;
                const categoryName = deleteCategoryBtn.dataset.name;
                handleDeleteCategoryClick(categoryId, categoryName);
                return;
            }
        });
        
        async function handleDeleteAccountClick(accountId, accountName) {
            if (!userId) return;
            
            openDeleteModal(`Are you sure you want to delete "${accountName}"? This will also delete ALL associated transactions. This cannot be undone.`, async () => {
                console.log(`DEBUG: Deleting account ${accountId}`);
                
                try {
                    const batch = writeBatch(db);
                    const accountRef = doc(db, `artifacts/${appId}/users/${userId}/accounts`, accountId);
                    batch.delete(accountRef);
                    
                    const txCollectionPath = `artifacts/${appId}/users/${userId}/transactions`;
                    const q = query(collection(db, txCollectionPath), where("accountId", "==", accountId));
                    const txSnapshot = await getDocs(q);
                    txSnapshot.forEach((doc) => { batch.delete(doc.ref); });
                    
                    /* V3.0: Also find transfers */
                    const qTo = query(collection(db, txCollectionPath), where("accountIdTo", "==", accountId));
                    const txToSnapshot = await getDocs(qTo);
                    txToSnapshot.forEach((doc) => { batch.delete(doc.ref); });
                    
                    await batch.commit();
                    console.log(`DEBUG: Successfully deleted account and ${txSnapshot.size + txToSnapshot.size} transactions.`);
                    
                } catch (error) {
                    console.error("Error deleting account and transactions:", error);
                    openDeleteModal("Error: " + error.message, () => {}, true);
                }
            });
        }
        
        async function handleDeleteCategoryClick(categoryId, categoryName) {
            if (!userId) return;
            
            const txInUse = userTransactions.some(tx => tx.category === categoryName);
            const scheduledInUse = userScheduledItems.some(item => item.category === categoryName);
            
            if (txInUse || scheduledInUse) {
                openDeleteModal(`Cannot delete category "${categoryName}".<br><br>It is currently in use by 1 or more transactions or scheduled items.`, () => {}, true);
                return;
            }
            
            openDeleteModal(`Are you sure you want to delete the category "${categoryName}"?`, async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/categories`, categoryId));
                } catch (error) {
                    console.error("Error deleting category:", error);
                }
            });
        }
        /* END: (14.8) Global Click Listener (for Deletes) */

        /* ================================================================= */
        /* (END 14.0) */
        /* ================================================================= */


        /* ================================================================= */
        /* (15.0) APP INITIALIZATION */
        /* ================================================================= */
        
        /* START: (15.1) App Initialization */
        function initializeApp() {
            if (localStorage.getItem('theme') === 'dark' || (window.matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('theme'))) {
                setDarkMode(true);
            } else {
                setDarkMode(false);
            }
            showPage('dashboard');
            populateCategoryOptions();
            setScheduledView('list');
            console.log("DEBUG: App initialized.");
        }
        
        initializeApp();
        /* END: (15.1) App Initialization */
        
        /* ================================================================= */
        /* (END 15.0) */
        /* ================================================================= */

    </script>
</body>
</html>